<script>
(async function () {

const BASE = "https://krynet-llc.github.io/KrySearch/UI/index.html";
const CONFIG_URL = "https://krynet-llc.github.io/KrySearch/UI/Config/config.json";

// -----------------------------
// Helpers
// -----------------------------

function setOG(property, content) {
    let tag = document.querySelector(`meta[property='${property}']`);
    if (!tag) {
        tag = document.createElement("meta");
        tag.setAttribute("property", property);
        document.head.appendChild(tag);
    }
    tag.setAttribute("content", content);
}

function setCanonical(url) {
    let link = document.querySelector("link[rel='canonical']");
    if (!link) {
        link = document.createElement("link");
        link.rel = "canonical";
        document.head.appendChild(link);
    }
    link.href = url;
}

function embedURL(targetUrl) {

    const container = document.createElement("div");
    container.style.margin = "20px auto";
    container.style.maxWidth = "900px";

    const ext = targetUrl.split(".").pop()?.toLowerCase();

    const videoExt = ["mp4","webm","mov","mkv"];
    const audioExt = ["mp3","wav","ogg","flac"];
    const imageExt = ["jpg","jpeg","png","gif","webp","bmp"];

    if (videoExt.includes(ext)) {
        const video = document.createElement("video");
        video.src = targetUrl;
        video.controls = true;
        video.style.width = "100%";
        container.appendChild(video);

    } else if (audioExt.includes(ext)) {
        const audio = document.createElement("audio");
        audio.src = targetUrl;
        audio.controls = true;
        audio.style.width = "100%";
        container.appendChild(audio);

    } else if (imageExt.includes(ext)) {
        const img = document.createElement("img");
        img.src = targetUrl;
        img.style.width = "100%";
        container.appendChild(img);

    } else if (targetUrl.includes("youtube.com") || targetUrl.includes("youtu.be")) {

        let videoId = null;

        if (targetUrl.includes("v=")) {
            videoId = new URL(targetUrl).searchParams.get("v");
        } else {
            videoId = targetUrl.split("/").pop();
        }

        const iframe = document.createElement("iframe");
        iframe.src = `https://www.youtube.com/embed/${videoId}`;
        iframe.width = "100%";
        iframe.height = "500";
        iframe.allowFullscreen = true;
        iframe.style.border = "none";

        container.appendChild(iframe);

    } else {
        const iframe = document.createElement("iframe");
        iframe.src = targetUrl;
        iframe.style.width = "100%";
        iframe.style.height = "700px";
        iframe.style.border = "none";
        container.appendChild(iframe);
    }

    document.body.appendChild(container);
}

// -----------------------------
// Parse URL
// -----------------------------

const params = new URLSearchParams(window.location.search);
const query = params.get("q");
const directUrl = params.get("url");
const engineParam = params.get("engine");

// -----------------------------
// Load config.json
// -----------------------------

let config;
try {
    const res = await fetch(CONFIG_URL);
    config = await res.json();
} catch (err) {
    console.error("Config load failed:", err);
    return;
}

const engines = {
    ...config.engines.open_source,
    ...config.engines.closed_source
};

const defaultEngine = config.search.defaultEngine;

const activeEngineName =
    engineParam && engines[engineParam]
        ? engineParam
        : defaultEngine;

const activeEngine = engines[activeEngineName];

// -----------------------------
// Main Logic
// -----------------------------

if (directUrl) {

    const canonical = `${BASE}?url=${encodeURIComponent(directUrl)}&engine=${activeEngineName}`;

    document.title = `KrySearch - Media (${activeEngineName})`;

    setCanonical(canonical);

    setOG("og:title", `KrySearch - Media Preview`);
    setOG("og:description", directUrl);
    setOG("og:url", canonical);

    // Media OG detection
    if (directUrl.endsWith(".mp4")) {
        setOG("og:type", "video.other");
        setOG("og:video", directUrl);
        setOG("og:video:type", "video/mp4");
    } else if (directUrl.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
        setOG("og:type", "image");
        setOG("og:image", directUrl);
    } else {
        setOG("og:type", "website");
    }

    embedURL(directUrl);

}
else if (query) {

    const canonical = `${BASE}?q=${encodeURIComponent(query)}&engine=${activeEngineName}`;

    const searchURL = activeEngine.url.replace(
        "{query}",
        encodeURIComponent(query)
    );

    document.title = `KrySearch - ${query} (${activeEngineName})`;

    setCanonical(canonical);

    setOG("og:title", `KrySearch - ${query}`);
    setOG("og:description", `Search results for "${query}" using ${activeEngineName}`);
    setOG("og:url", canonical);
    setOG("og:type", "website");

    embedURL(searchURL);

}
else {

    document.title = "KrySearch - Search Engine";
    setOG("og:title", "KrySearch - Search Engine");
    setOG("og:description", "Search and embed media with KrySearch.");
    setOG("og:type", "website");

    document.body.innerHTML += "<p style='text-align:center;margin-top:50px;'>No query or URL provided.</p>";

}

})();
</script>
